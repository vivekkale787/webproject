<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chat - KrishiMitra</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="chat-container">
        <!-- Sidebar -->
        <div class="chat-sidebar">
            <div class="chat-sidebar-header">
                <h2 class="chat-sidebar-title">üåæ KrishiMitra Chat</h2>
                <button class="btn-new-chat" onclick="startNewChat()">
                    + New Chat
                </button>
            </div>
            
            <div style="padding: 1.5rem;">
                <h3 style="font-size: 0.875rem; font-weight: 500; color: #6b7280; margin-bottom: 1rem;">Recent Sessions</h3>
                <div id="sessionsList" class="sessions-list">
                    <!-- Sessions will be populated by JavaScript -->
                </div>
            </div>

            <div style="padding: 1.5rem; border-top: 1px solid #e5e7eb;">
                <h3 style="font-size: 0.875rem; font-weight: 500; color: #6b7280; margin-bottom: 1rem;">Chat Modes</h3>
                <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                    <button class="mode-btn active" id="textModeBtn" onclick="setChatMode('text')">
                        üí¨ Text Chat
                    </button>
                    <button class="mode-btn" id="imageModeBtn" onclick="setChatMode('image')">
                        üì∏ Image Analysis
                    </button>
                </div>
            </div>

            <div style="padding: 1.5rem; border-top: 1px solid #e5e7eb;">
                <div style="text-align: center;">
                    <button onclick="logout()" style="color: #dc2626; background: none; border: none; cursor: pointer; text-decoration: underline;">
                        Logout
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Chat Area -->
        <div class="chat-main">
            <!-- Header -->
            <div class="chat-header">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h1 class="chat-title" id="chatTitle">üí¨ Farming Assistant</h1>
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <span style="font-size: 0.875rem; color: #6b7280;" id="userWelcome"></span>
                        <a href="index.html" style="color: #16a34a; text-decoration: none;">‚Üê Home</a>
                    </div>
                </div>
            </div>

            <!-- Messages -->
            <div class="chat-messages" id="chatMessages">
                <div class="chat-welcome">
                    <div class="chat-welcome-icon">üåæ</div>
                    <h3 class="chat-welcome-title">Welcome to KrishiMitra!</h3>
                    <p id="welcomeText">Ask me anything about farming, crops, soil, weather, or market prices.</p>
                </div>
            </div>

            <!-- Input Area -->
            <div class="chat-input">
                <form class="chat-form" id="chatForm">
                    <div id="imagePreview" style="display: none; margin-right: 1rem;">
                        <div style="position: relative;">
                            <img id="previewImg" style="width: 3rem; height: 3rem; object-fit: cover; border-radius: 0.5rem;">
                            <button type="button" onclick="removeImage()" style="position: absolute; top: -0.5rem; right: -0.5rem; background: #dc2626; color: white; border: none; border-radius: 50%; width: 1.5rem; height: 1.5rem; font-size: 0.75rem; cursor: pointer;">√ó</button>
                        </div>
                    </div>
                    
                    <input type="file" id="imageInput" accept="image/*" style="display: none;" onchange="handleImageSelect(event)">
                    
                    <div style="display: flex; align-items: flex-end; gap: 0.5rem; flex: 1;">
                        <button type="button" id="imageBtn" onclick="document.getElementById('imageInput').click()" style="background: #f3f4f6; border: 1px solid #d1d5db; border-radius: 0.5rem; padding: 0.75rem; cursor: pointer; display: none;">
                            üì∏
                        </button>
                        
                        <textarea 
                            id="messageInput" 
                            class="chat-textarea" 
                            placeholder="Ask about farming, crops, soil, weather..."
                            rows="2"
                            onkeypress="handleKeyPress(event)"
                        ></textarea>
                    </div>
                    
                    <button type="submit" class="btn-send" id="sendBtn">
                        Send
                    </button>
                </form>
                
                <div style="margin-top: 0.5rem; font-size: 0.75rem; color: #6b7280; text-align: center;">
                    üí° Pro tip: Upload images of your crops for detailed analysis and disease detection
                </div>
            </div>
        </div>
    </div>

    <script src="script.js"></script>
    <script>
        let currentChatMode = 'text';
        let messages = [];
        let currentSessionId = null;

        // Check authentication
        function checkAuth() {
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            if (!user.isAuthenticated) {
                window.location.href = 'login.html';
                return null;
            }
            return user;
        }

        // Initialize chat
        function initChat() {
            const user = checkAuth();
            if (!user) return;
            
            document.getElementById('userWelcome').textContent = `Welcome, ${user.username}!`;
            loadSessions();
        }

        // Set chat mode
        function setChatMode(mode) {
            currentChatMode = mode;
            
            // Update UI
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(mode + 'ModeBtn').classList.add('active');
            
            // Update placeholders and visibility
            const messageInput = document.getElementById('messageInput');
            const imageBtn = document.getElementById('imageBtn');
            const chatTitle = document.getElementById('chatTitle');
            const welcomeText = document.getElementById('welcomeText');
            
            if (mode === 'text') {
                messageInput.placeholder = 'Ask about farming, crops, soil, weather...';
                imageBtn.style.display = 'none';
                chatTitle.textContent = 'üí¨ Farming Assistant';
                welcomeText.textContent = 'Ask me anything about farming, crops, soil, weather, or market prices.';
            } else {
                messageInput.placeholder = 'Describe what you want to know about the image...';
                imageBtn.style.display = 'block';
                chatTitle.textContent = 'üì∏ Crop Analysis';
                welcomeText.textContent = 'Upload an image of your crops for AI-powered analysis and advice.';
            }
        }

        // Handle image selection
        function handleImageSelect(event) {
            const file = event.target.files[0];
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('previewImg').src = e.target.result;
                    document.getElementById('imagePreview').style.display = 'block';
                    setChatMode('image');
                };
                reader.readAsDataURL(file);
            }
        }

        // Remove selected image
        function removeImage() {
            document.getElementById('imagePreview').style.display = 'none';
            document.getElementById('imageInput').value = '';
            setChatMode('text');
        }

        // Send message
        function sendMessage(event) {
            event.preventDefault();
            
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            
            if (!message) return;
            
            // Add user message
            addMessage('user', message);
            
            // Clear input
            messageInput.value = '';
            
            // Show typing indicator
            showTypingIndicator();
            
            // Simulate AI response (replace with actual API call)
            setTimeout(() => {
                removeTypingIndicator();
                
                const responses = [
                    "Based on your question about farming, here are some helpful insights:\n\n‚Ä¢ Consider soil pH levels for optimal crop growth\n‚Ä¢ Monitor weather patterns for irrigation planning\n‚Ä¢ Use integrated pest management techniques\n‚Ä¢ Consider crop rotation for soil health",
                    "For crop disease management:\n\n‚Ä¢ Early detection is crucial\n‚Ä¢ Use resistant varieties when available\n‚Ä¢ Practice good field sanitation\n‚Ä¢ Consider biological control methods\n‚Ä¢ Apply fungicides only when necessary",
                    "Here are some market insights:\n\n‚Ä¢ Current crop prices are influenced by seasonal demand\n‚Ä¢ Consider value-added processing for better margins\n‚Ä¢ Direct-to-consumer sales can increase profits\n‚Ä¢ Storage facilities can help time market entry",
                    "Weather considerations for farming:\n\n‚Ä¢ Check 7-day forecasts for planning\n‚Ä¢ Monitor soil moisture levels\n‚Ä¢ Protect crops during extreme weather\n‚Ä¢ Use weather data for pest predictions"
                ];
                
                const randomResponse = responses[Math.floor(Math.random() * responses.length)];
                addMessage('bot', randomResponse);
                
                // Save to session
                saveToSession(message, randomResponse);
                
            }, 1500 + Math.random() * 1000);
        }

        // Add message to chat
        function addMessage(type, content, imageUrl = null) {
            const messagesContainer = document.getElementById('chatMessages');
            const welcomeDiv = messagesContainer.querySelector('.chat-welcome');
            
            if (welcomeDiv) {
                welcomeDiv.style.display = 'none';
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            
            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            
            if (imageUrl && type === 'user') {
                const img = document.createElement('img');
                img.src = imageUrl;
                img.style.width = '100%';
                img.style.borderRadius = '0.5rem';
                img.style.marginBottom = '0.5rem';
                messageContent.appendChild(img);
            }
            
            const textDiv = document.createElement('div');
            textDiv.style.whiteSpace = 'pre-line';
            textDiv.textContent = content;
            messageContent.appendChild(textDiv);
            
            const timeDiv = document.createElement('div');
            timeDiv.className = 'message-time';
            timeDiv.textContent = new Date().toLocaleTimeString();
            messageContent.appendChild(timeDiv);
            
            messageDiv.appendChild(messageContent);
            messagesContainer.appendChild(messageDiv);
            
            // Scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // Store message
            messages.push({
                type,
                content,
                timestamp: new Date().toISOString(),
                imageUrl
            });
        }

        // Show typing indicator
        function showTypingIndicator() {
            const messagesContainer = document.getElementById('chatMessages');
            
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message bot';
            typingDiv.id = 'typingIndicator';
            
            const typingContent = document.createElement('div');
            typingContent.className = 'message-content';
            typingContent.innerHTML = '<div style="display: flex; align-items: center; gap: 0.5rem;"><div style="width: 1rem; height: 1rem; border: 2px solid #16a34a; border-radius: 50%; border-top-color: transparent; animation: spin 1s linear infinite;"></div><span>Thinking...</span></div>';
            
            typingDiv.appendChild(typingContent);
            messagesContainer.appendChild(typingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Remove typing indicator
        function removeTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        // Handle enter key
        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage(event);
            }
        }

        // Start new chat
        function startNewChat() {
            messages = [];
            currentSessionId = null;
            document.getElementById('chatMessages').innerHTML = `
                <div class="chat-welcome">
                    <div class="chat-welcome-icon">üåæ</div>
                    <h3 class="chat-welcome-title">Welcome to KrishiMitra!</h3>
                    <p id="welcomeText">Ask me anything about farming, crops, soil, weather, or market prices.</p>
                </div>
            `;
            removeImage();
        }

        // Load sessions (mock data)
        function loadSessions() {
            const sessions = JSON.parse(localStorage.getItem('chatSessions') || '[]');
            const sessionsList = document.getElementById('sessionsList');
            
            sessionsList.innerHTML = '';
            
            sessions.slice(0, 10).forEach((session, index) => {
                const sessionDiv = document.createElement('div');
                sessionDiv.className = 'session-item';
                sessionDiv.style.cssText = 'padding: 0.75rem; border-radius: 0.5rem; cursor: pointer; transition: background-color 0.3s ease; margin-bottom: 0.5rem;';
                sessionDiv.innerHTML = `
                    <div style="font-size: 0.875rem; font-weight: 500;">Session ${index + 1}</div>
                    <div style="font-size: 0.75rem; color: #6b7280;">${session.messageCount} messages</div>
                `;
                
                sessionDiv.addEventListener('mouseenter', () => {
                    sessionDiv.style.backgroundColor = '#f3f4f6';
                });
                
                sessionDiv.addEventListener('mouseleave', () => {
                    sessionDiv.style.backgroundColor = 'transparent';
                });
                
                sessionDiv.addEventListener('click', () => {
                    loadSession(session);
                });
                
                sessionsList.appendChild(sessionDiv);
            });
        }

        // Save to session
        function saveToSession(userMessage, botResponse) {
            let sessions = JSON.parse(localStorage.getItem('chatSessions') || '[]');
            
            if (!currentSessionId) {
                currentSessionId = 'session_' + Date.now();
                sessions.unshift({
                    id: currentSessionId,
                    messageCount: 0,
                    lastMessage: new Date().toISOString(),
                    messages: []
                });
            }
            
            const session = sessions.find(s => s.id === currentSessionId);
            if (session) {
                session.messages.push({
                    user: userMessage,
                    bot: botResponse,
                    timestamp: new Date().toISOString()
                });
                session.messageCount = session.messages.length;
                session.lastMessage = new Date().toISOString();
            }
            
            localStorage.setItem('chatSessions', JSON.stringify(sessions));
            loadSessions();
        }

        // Load session
        function loadSession(session) {
            currentSessionId = session.id;
            messages = [];
            
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.innerHTML = '';
            
            session.messages.forEach(msg => {
                addMessage('user', msg.user);
                addMessage('bot', msg.bot);
            });
        }

        // Logout
        function logout() {
            localStorage.removeItem('user');
            window.location.href = 'index.html';
        }

        // Event listeners
        document.getElementById('chatForm').addEventListener('submit', sendMessage);

        // Initialize
        initChat();
    </script>

    <style>
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .mode-btn {
            width: 100%;
            padding: 0.75rem;
            background: none;
            border: none;
            border-radius: 0.5rem;
            text-align: left;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #6b7280;
            font-size: 0.875rem;
        }

        .mode-btn.active {
            background-color: #f0fdf4;
            color: #16a34a;
        }

        .mode-btn:hover {
            background-color: #f3f4f6;
            color: #374151;
        }
    </style>
</body>
</html>